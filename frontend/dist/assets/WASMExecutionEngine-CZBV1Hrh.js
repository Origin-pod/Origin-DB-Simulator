var h=Object.defineProperty;var w=(c,e,t)=>e in c?h(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var g=(c,e,t)=>w(c,typeof e!="symbol"?e+"":e,t);import{g as m}from"./index-U8JUSap4.js";class O{isReady(){return m()!==null}initRuntime(){this.getModule().init_runtime()}destroyRuntime(){this.getModule().destroy_runtime()}registerBlock(e){const r=this.getModule().register_block(JSON.stringify(e)),n=JSON.parse(r);if(n.error)throw new Error(`Failed to register block "${e.id}": ${n.error}`);return n.id??e.id}createConnection(e,t){const r=this.getModule(),n={source_block_id:e.blockId,source_port_id:e.portName,target_block_id:t.blockId,target_port_id:t.portName,backpressure:!1,buffer_size:null},s=r.create_connection(JSON.stringify(n)),a=JSON.parse(s);if(a.error)throw new Error(`Failed to connect ${e.blockId}:${e.portName} â†’ ${t.blockId}:${t.portName}: ${a.error}`);return a.id??""}validate(){const t=this.getModule().validate();return JSON.parse(t)}execute(e,t){const r=this.getModule(),n=a=>{try{const l=JSON.parse(a);t(l)}catch{}},s=r.execute(JSON.stringify(e),n);return JSON.parse(s)}cancel(){this.getModule().cancel_execution()}getMetrics(){const t=this.getModule().get_metrics();return JSON.parse(t)}getBlockTypes(){const t=this.getModule().get_block_types();return JSON.parse(t)}getModule(){const e=m();if(!e)throw new Error("WASM module is not loaded. Call loadWASM() first.");return e}}let d=null;function p(){return d||(d=new O),d}class y{constructor(){g(this,"cancelled",!1)}validate(e,t){const r=p();r.initRuntime();for(const s of e){const a=s.data,l={type:a.blockType,id:s.id,parameters:{...a.parameters}};r.registerBlock(l)}for(const s of t)s.sourceHandle&&s.targetHandle&&r.createConnection({blockId:s.source,portName:s.sourceHandle},{blockId:s.target,portName:s.targetHandle});const n=r.validate();return{valid:n.valid,errors:n.errors.map(s=>({message:s})),warnings:n.warnings.map(s=>({message:s}))}}async execute(e,t,r,n){this.cancelled=!1;const s=this.validate(e,t);if(!s.valid)return{success:!1,duration:0,metrics:{throughput:0,latency:{avg:0,p50:0,p95:0,p99:0},totalOperations:r.totalOperations,successfulOperations:0,failedOperations:0},blockMetrics:[],errors:s.errors.map(o=>o.message)};const a=p(),l={operations:r.operations.map(o=>({type:o.type,weight:o.weight,template:o.template})),distribution:r.distribution,concurrency:r.concurrency,totalOps:r.totalOperations},u=a.execute(l,o=>{this.cancelled||n({phase:o.phase==="aggregating"?"aggregating":"executing",progress:o.progress,currentBlock:o.currentBlockId,message:o.message})});if(!u.success)return{success:!1,duration:u.duration,metrics:{throughput:0,latency:{avg:0,p50:0,p95:0,p99:0},totalOperations:r.totalOperations,successfulOperations:0,failedOperations:0},blockMetrics:[],errors:u.errors??["WASM execution failed."]};const i=u.metrics,f=i.blockMetrics.map(o=>({blockId:o.blockId,blockType:o.blockType,blockName:o.blockName,executionTime:o.executionTime,percentage:o.percentage,counters:o.counters}));return{success:!0,duration:u.duration,metrics:{throughput:i.throughput,latency:i.latency,totalOperations:i.totalOperations,successfulOperations:i.successfulOperations,failedOperations:i.failedOperations},blockMetrics:f}}cancel(){this.cancelled=!0;try{p().cancel()}catch{}}}export{y as WASMExecutionEngine};
